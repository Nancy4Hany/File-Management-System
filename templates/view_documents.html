<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document List</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>

<div class="container">
    <h1 class="mt-5">Document List</h1>

    <table class="table table-striped mt-3">
        <thead>
            <tr>
                <th>Title</th>
                <th>Description</th>
                <th>Uploaded At</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="documentList"></tbody>
    </table>

    <a href="/upload" class="btn btn-primary mt-3">Upload New Document</a>
</div>

<script>
    async function fetchWithToken(url, options = {}) {
        let token = localStorage.getItem('authToken');
        if (!token) {
            console.error('Token not found in local storage');
            return;
        }

        let response = await fetch(url, {
            ...options,
            headers: {
                'Authorization': `Bearer ${token}`,
                ...options.headers
            }
        });

        if (response.status === 401) {
            const refreshTokenResponse = await fetch('/refresh-token', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (refreshTokenResponse.status !== 200) {
                console.error('Failed to refresh token');
                return;
            }

            const newToken = await refreshTokenResponse.json();
            localStorage.setItem('authToken', newToken.token);
            token = newToken.token;

            response = await fetch(url, {
                ...options,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    ...options.headers
                }
            });
        }

        return response;
    }

    fetchWithToken('/documents')
        .then(response => response.json())
        .then(data => {
            const documentList = document.getElementById('documentList');
            documentList.innerHTML = '';

            data.forEach(document => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${document.title}</td>
                    <td>${document.description || 'No description provided'}</td>
                    <td>${new Date(document.uploaded_at).toLocaleString()}</td>
                    <td>${document.status}</td>
                    <td>
                        <a href="/documents/${document.id}/view" class="btn btn-info btn-sm">View</a>
                        <a href="/documents/${document.id}/edit" class="btn btn-warning btn-sm">Edit</a>
                        <form action="/documents/${document.id}/delete" method="POST" style="display:inline;">
                            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this document?');">Delete</button>
                        </form>
                    </td>
                `;
                documentList.appendChild(row);
            });
        })
        .catch(error => console.error('Error fetching documents:', error));
</script>

</body>
</html>
